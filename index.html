<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Alliteration Animal Namer — v19</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#151518; --text:#f6f7fb; --muted:#a9adc1; --ring:#3b82f6;
      --red:#ef4444; --green:#10b981; --blue:#3b82f6; --accent:#6ee7ff;
      --play:#16a34a; --playGlow:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0b0c,#111217 40%,#0b0b0c);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;min-height:100dvh}
    .wrap{max-width:980px;margin:0 auto;padding:8px 16px 120px}

    /* Sticky banner prompt at absolute top */
    .banner{position:sticky;top:0;z-index:120;background:#0b0b0c;box-shadow:0 6px 16px rgba(0,0,0,.35);border-bottom:1px solid #23242d}
    .banner .output{margin:8px 0 0;padding:18px 12px;border-radius:12px;background:#0f1117;border:1px solid #2a2e3d;font-size:clamp(36px,8vw,78px);line-height:1.15;cursor:pointer;user-select:none}
    .emo{color:var(--red);font-weight:900;text-transform:none}
    .animal{color:var(--green);font-weight:900}
    .name{color:var(--blue);font-weight:900}

    header{display:flex;flex-direction:column;gap:8px;margin:10px 0 12px}
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:clamp(18px,3vw,24px);margin:0;font-weight:800;letter-spacing:.2px}

    .card{background:var(--card);border:1px solid #23242d;border-radius:20px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}

    .btn{appearance:none;border:1px solid #2a2f3d;background:#121420;color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:background .2s,border-color .2s,box-shadow .2s}
    .btn.small{padding:8px 10px;font-size:12px}
    .btn.big{padding:16px 20px;font-size:16px;border-radius:16px}
    .btn.icon{padding:10px 12px;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn.icon svg{width:18px;height:18px;display:block}
    .btn:active{transform:translateY(1px)}
    .btn.active{background:linear-gradient(135deg,var(--play),var(--playGlow));border-color:transparent;box-shadow:0 0 0 3px rgba(34,197,94,.25)}

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Page 1 search + suggestions */
    .field{position:relative}
    input[type="text"]{width:100%;padding:16px 48px 16px 16px;border-radius:14px;border:1px solid #272a36;background:#0f1117;color:var(--text);font-size:18px;outline:none;transition:border .18s, box-shadow .18s}
    input[type="text"]:focus{border-color:var(--ring);box-shadow:0 0 0 4px rgba(59,130,246,.25)}
    .p1bar{display:flex;gap:10px;align-items:center;margin-bottom:6px}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .toggle input{width:18px;height:18px}

    .suggestions{position:relative;margin-top:8px}
    .suggestions ul{position:absolute;z-index:40;list-style:none;margin:0;padding:6px;background:#0f1117;border:1px solid #262a36;border-radius:12px;width:100%;max-height:260px;overflow:auto;box-shadow:0 20px 30px rgba(0,0,0,.35)}
    .suggestions li{padding:10px 12px;border-radius:10px;cursor:pointer}
    .suggestions li[aria-selected="true"], .suggestions li:hover{background:#1a1f2b}

    /* Bottom sheet */
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#0f1117;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid #262a36;box-shadow:0 -20px 30px rgba(0,0,0,.45);transition:bottom .25s ease;z-index:110}
    .sheet.open{bottom:0}
    .sheet .handle{width:54px;height:6px;background:#2a2f3d;border-radius:10px;margin:10px auto}
    .sheet .tabs{display:flex;gap:8px;justify-content:center;margin:8px 0;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid #2a2f3d;background:#15171f;color:#fff;font-weight:700;cursor:pointer}
    .navFlip{display:flex;gap:8px;justify-content:center;margin:0 0 8px}
    .pages{display:flex;transition:transform .25s ease}
    .page{min-width:100vw;max-width:100vw;padding:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;max-height:46vh;overflow:auto;padding-right:4px}

    /* Startup signature splash */
    .splash{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;z-index:200;transition:opacity .6s ease, transform .6s ease}
    .splash .pill{background:#151518;border:1px solid #2a2e3d;color:#a9adc1;padding:10px 14px;border-radius:999px;box-shadow:0 8px 20px rgba(0,0,0,.45)}
    .splash.hide{opacity:0;pointer-events:none;transform:translateY(10px)}

    /* Focus (enlarged) mode */
    body.focus header, body.focus .card, body.focus .sheet, body.focus .footer, body.focus .topbar{ display:none !important; }
    body.focus .banner{ box-shadow:none; border-bottom:none; }
    body.focus .banner .output{ font-size:clamp(44px,12vw,128px); padding:28px 16px; }
    body.focus .emo, body.focus .animal, body.focus .name{ display:block; text-align:left; }
    @media (orientation:landscape){ body.focus .emo, body.focus .animal, body.focus .name{ display:inline; text-align:left; } body.focus .banner .output{ text-align:left; } }

    /* Focus controls overlay: bottom-left, big buttons */
    .focusControls{position:fixed;bottom:14px;left:14px;z-index:130;display:none;gap:10px}
    body.focus .focusControls{display:flex}

    .footer{margin:28px 2px 12px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap" id="appArea">
    <!-- Sticky Prompt Banner at the very top -->
    <div class="banner">
      <div class="output" id="result" title="Click for New phrase (also click empty space)">Your phrase will appear here…</div>
    </div>

    <!-- Focus-mode overlay controls (Play first, then Minimize) -->
    <div class="focusControls" id="focusControls">
      <button class="btn big" id="focusPlayBtn" title="Play / Stop">Play</button>
      <button class="btn big" id="minimizeBtn" title="Exit enlarged view">Minimize</button>
    </div>

    <header>
      <div class="topbar">
        <button class="btn icon play" id="playBtn" title="Play / Stop" aria-label="Play">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="btn icon" id="audioBtn" title="Audio on/off" aria-label="Audio">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 10v4h4l5 5V5L7 10H3zm13 2a4 4 0 00-4-4v8a4 4 0 004-4zm0-6a10 10 0 010 12V6z"/></svg>
        </button>
        <button class="btn icon" id="settingsBtn" title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.48.48,0,0,0,.11-.61l-2-3.46a.5.5,0,0,0-.6-.22L16.9,5.5a7.5,7.5,0,0,0-1.63-.94l-.25-2.65A.49.49,0,0,0,14.54,1H9.46a.49.49,0,0,0-.48.41L8.73,4.06A7.5,7.5,0,0,0,7.1,5L4.24,4.12a.5.5,0,0,0-.6.22l-2,3.46a.48.48,0,0,0,.11.61L3.86,10a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.75,13.53a.48.48,0,0,0-.11.61l2,3.46a.5.5,0,0,0,.6.22L7.1,18.5a7.5,7.5,0,0,0,1.63.94l.25,2.65a.49.49,0,0,0,.48.41h5.08a.49.49,0,0,0,.48-.41l.25-2.65a7.5,7.5,0,0,0,1.63-.94l2.86.88a.5.5,0,0,0,.6-.22l2-3.46a.48.48,0,0,0-.11-.61ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
        </button>
      </div>
      <h1>Alliteration Animal Namer</h1>
    </header>

    <div class="card">
      <div class="p1bar">
        <label class="toggle"><input type="checkbox" id="alphaToggle" /> ABC next-letter</label>
      </div>
      <div class="field">
        <input id="page1Search" type="text" placeholder="Type a prefix. ↑/↓ navigate, Enter select. ← prev • → next • Enter = New phrase" autocomplete="off" />
        <div class="suggestions" id="p1Suggest"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="newPhraseBtn">New phrase</button>
        <button class="btn" id="newAnimalBtn">New animal</button>
        <button class="btn" id="newNameBtn">New name</button>
        <button class="btn" id="openSheet">Open pages</button>
        <button class="btn" id="enlargeBtn">Enlarge</button>
      </div>
    </div>

    <p class="footer">Output: <span class="emo">first word</span> <span class="animal">animal</span> <span class="name">name</span>. Staged reveal times are configurable; phonetic mode matches starting sounds.</p>
  </div>

  <!-- Bottom sheet: list-only pages with fast flip -->
  <div class="sheet" id="sheet">
    <div class="handle"></div>
    <div class="tabs">
      <button class="tab" data-ix="0">A–E</button>
      <button class="tab" data-ix="1">F–J</button>
      <button class="tab" data-ix="2">K–O</button>
      <button class="tab" data-ix="3">P–Z</button>
      <button class="tab" id="closeSheet">Close</button>
    </div>
    <div class="navFlip">
      <button class="btn small" id="flipPrev">‹ Prev</button>
      <button class="btn small" id="flipNext">Next ›</button>
    </div>
    <div class="pages" id="pages">
      <div class="page"><div class="grid" id="grid12"></div></div>
      <div class="page"><div class="grid" id="gridFJ"></div></div>
      <div class="page"><div class="grid" id="gridKO"></div></div>
      <div class="page"><div class="grid" id="gridPZ"></div></div>
    </div>
  </div>

  <!-- Settings (groups, phonetic, delay function, and time between prompts) -->
  <div class="sheet" id="settings" style="padding-bottom:20px">
    <div class="handle"></div>
    <div style="padding:12px 16px;display:grid;gap:16px">
      <section>
        <h3 style="margin:0 0 8px">Word groups shown</h3>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <label class="toggle"><input type="checkbox" id="chkEmotion" checked /> Emotion</label>
          <label class="toggle"><input type="checkbox" id="chkChem" checked /> Chemistry</label>
          <label class="toggle"><input type="checkbox" id="chkMove" checked /> Movement</label>
          <label class="toggle"><input type="checkbox" id="chkAnimal" checked /> Animal</label>
          <label class="toggle"><input type="checkbox" id="chkName" checked /> Name</label>
        </div>
        <div class="row" style="gap:12px;margin-top:8px">
          <label class="toggle"><input type="checkbox" id="phoneticToggle" checked /> Phonetic alliteration (same starting sound)</label>
        </div>
      </section>

      <section>
        <h3 style="margin:0 0 8px">Delay function (staged reveal)</h3>
        <div class="row" style="gap:12px;align-items:center">
          <label class="toggle"><input type="checkbox" id="delayToggle" checked /> Enable</label>
          <span style="color:var(--muted);font-size:12px">Default: <strong>3s</strong> between words; <strong>9s</strong> first→first.</span>
        </div>
        <div class="row" style="gap:24px;flex-wrap:wrap;margin-top:8px">
          <div>
            <div style="font-weight:700;margin-bottom:6px">Between each word</div>
            <div class="row" style="gap:6px">
              <button class="btn small setWordGap" data-v="1">1s</button>
              <button class="btn small setWordGap" data-v="2">2s</button>
              <button class="btn small setWordGap" data-v="3">3s</button>
              <button class="btn small setWordGap" data-v="4">4s</button>
              <button class="btn small setWordGap" data-v="5">5s</button>
              <button class="btn small setWordGap" data-v="6">6s</button>
            </div>
          </div>
          <div>
            <div style="font-weight:700;margin-bottom:6px">First → next First (whole phrase cadence)</div>
            <div class="row" style="gap:6px">
              <button class="btn small setSeg" data-v="2">2s</button>
              <button class="btn small setSeg" data-v="3">3s</button>
              <button class="btn small setSeg" data-v="6">6s</button>
              <button class="btn small setSeg" data-v="9">9s</button>
              <button class="btn small setSeg" data-v="12">12s</button>
              <button class="btn small setSeg" data-v="15">15s</button>
              <button class="btn small setSeg" data-v="18">18s</button>
              <button class="btn small setSeg" data-v="20">20s</button>
              <button class="btn small setSeg" data-v="30">30s</button>
              <button class="btn small setSeg" data-v="40">40s</button>
            </div>
          </div>
        </div>
        <p style="margin:8px 0 0; color:var(--muted); font-size:12px">Example: 3s between words + 9s first→first ⇒ 3s (w1→w2), 3s (w2→w3), then 3s (w3→next w1).</p>
      </section>

      <section>
        <h3 style="margin:0 0 8px">Time between prompts (used when Delay is OFF)</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn small setGap" data-gap="3">3s</button>
          <button class="btn small setGap" data-gap="5">5s</button>
          <button class="btn small setGap" data-gap="10">10s</button>
          <button class="btn small setGap" data-gap="15">15s</button>
          <button class="btn small setGap" data-gap="20">20s</button>
          <button class="btn small setGap" data-gap="30">30s</button>
          <button class="btn small setGap" data-gap="40">40s</button>
          <button class="btn small setGap" data-gap="50">50s</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Startup splash (shows for 30s then fades) -->
  <div class="splash" id="splash"><div class="pill">Jimmy James 24.09.2025 - v19</div></div>

  <script>
    // ==== DATA ==============================================================
    const animalsByLetter = {
      a:['ant','aardvark','albatross','anole','auk','axolotl'],
      b:['bear','beaver','buffalo','baboon','bluebird','boar'],
      c:['cheetah','cougar','capybara','cobra','crab','crow'],
      d:['dog','deer','dolphin','duck','donkey','dragonfly'],
      e:['eagle','emu','eel','elephant','egret','echidna'],
      f:['fox','frog','falcon','ferret','flamingo','firefly'],
      g:['giraffe','goat','goose','gecko','gorilla','goldfish'],
      h:['horse','hamster','heron','hyena','hedgehog','hawk'],
      i:['iguana','impala','ibis','inchworm','isopod','irish setter'],
      j:['jaguar','jellyfish','jackal','jay','jerboa','joey'],
      k:['koala','kangaroo','kingfisher','kestrel','kiwi','komodo'],
      l:['lion','lemur','lobster','llama','lynx','lark'],
      m:['monkey','moose','magpie','macaw','marmot','mantis'],
      n:['narwhal','newt','nightingale','nighthawk','nudibranch','nene'],
      o:['owl','otter','ocelot','oriole','orangutan','ox'],
      p:['penguin','panda','panther','parrot','puffin','porpoise'],
      q:['quail','quetzal','quokka','queen bee','quoll','quagga'],
      r:['rabbit','raccoon','ram','raven','robin','reindeer'],
      s:['seal','sparrow','shark','swan','serval','skunk'],
      t:['tiger','turkey','toucan','tortoise','tapir','tarantula'],
      u:['urchin','uakari','urial','uguisu','umbrella bird','unicornfish'],
      v:['viper','vulture','vicuna','vole','vaquita','veery'],
      w:['wolf','walrus','wren','weasel','whale','wombat'],
      x:['x-ray tetra','xerus','xenops','xoloitzcuintli','xenopus','xantus hummingbird'],
      y:['yak','yellowtail','yabby','yapok','yellowhammer','yakutian laika'],
      z:['zebra','zorilla','zebu','zander','zooplankter','zipper fish'],
    };

    const namesByLetter = {
      a:['Alex','Anjitha','Aree','Amelia','Arnold','Ava'],
      b:['Barry','Bella','Brian','Beatrice','Bruno','Bianca'],
      c:['Charlie','Claire','Carlos','Caroline','Cynthia','Cedric'],
      d:['Daisy','Daniel','Derek','Delilah','Diego','Daphne'],
      e:['Ella','Edward','Eve','Elijah','Emilia','Ethan'],
      f:['Felix','Fiona','Frank','Faith','Freya','Floyd'],
      g:['George','Geetha','Grace','Gabriel','Gavin','Giselle','Giraffe?'],
      h:['Hank','Hannah','Harry','Hazel','Helen','Hugo'],
      i:['Isla','Isaac','India','Ivan','Ivy','Ines'],
      j:['Jasper','Julie','Jordan','June','Jonah','James','Jim','Jimmy'],
      k:['Katie','Kevin','Kira','Khalid','Kyle','Kara'],
      l:['Leo','Luna','Liam','Layla','Logan','Lorenzo'],
      m:['Max','Mia','Mason','Maya','Miles','Maggie'],
      n:['Nora','Noah','Naomi','Nelson','Natalie','Nate'],
      o:['Oliver','Olivia','Oscar','Opal','Owen','Orla'],
      p:['Piper','Paul','Penelope','Phoebe','Peter','Pravin'],
      q:['Quinn','Quentin','Queen','Quincy','Quiana','Quade'],
      r:['Ruby','Ryan','Rachel','Rafael','Riley','Remi'],
      s:['Sally','Sam','Santiago','Sophia','Sarachandra','Simon','Shabana','Shayla'],
      t:['Tony','Tina','Thomas','Talia','Trevor','Tracy'],
      u:['Uma','Ulysses','Ursula','Ugne','Ulric','Umi'],
      v:['Violet','Victor','Vanessa','Valentina','Vikram','Vince'],
      w:['Wendy','Will','Willow','Wesley','Wanda','Winston'],
      x:['Xavier','Xena','Ximena','Xander','Xia','Xaviera'],
      y:['Yara','Yosef','Yasmin','Yuki','Yolanda','Yuri'],
      z:['Zoe','Zach','Zara','Zeke','Zelda','Zane'],
    };

    // Emotion/Movement/Extra
    const emotionList = [
      'afraid','agitated','aloof','amused','angry','annoyed','anxious','ashamed','astonished','awkward','baffled','bitter','blissful','bold','brave','calm','cheerful','confident','confused','content','cranky','curious','defiant','delighted','depressed','determined','disgusted','dismayed','eager','ecstatic','embarrassed','envious','excited','fearful','frustrated','giddy','gloomy','grateful','grumpy','guilty','happy','hopeful','hostile','impatient','insecure','irritated','joyful','lonely','melancholy','nervous','optimistic','overwhelmed','peaceful','proud','relieved','resentful','restless','satisfied','scared','serene','shocked','shy','silly','sorrowful','startled','stressed','tense','tired','tranquil','upbeat','wistful','zealous'
    ];
    const movementList = [
      'arching','basking','bending','bouncy','bounding','breathing','bursting','crawling','choppy','contracting','circling','coiling','creeping','darting','dragging','drooping','expanding','fast','floating','flowing','fluttering','galloping','gliding','hopping','heavy','jerky','leaping','light','lunging','marching','pirouetting','pulsing','quivering','rigid','rolling','rocking','sprinting','sauntering','shuffling','skipping','slithering','spiraling','staggering','stomping','striding','swaying','swinging','tilting','tiptoeing','trembling','twisting','undulating','vibrating','wobbling','zigzagging'
    ];
    const extraList = ['bad','brisk','bright','bouncy','bold','soft','strong','swift','sturdy','spry','sleepy','soggy','silky','harmful','haphazardful'];

    // Chemistry/Science
    const chemistryList = [
      'acidic','activated','aerobic','alkaline','allotropic','amphoteric','aqueous','atomic',
      'basic','binding','biochemical','boiling','bonded','buffered','buoyant',
      'catalytic','charged','chemical','colloidal','conductive','crystalline','covalent',
      'diffusive','dilute','dimeric','dynamic',
      'electrolytic','endothermic','enzymatic','equilibrated','exothermic',
      'ferrous','ferric','fluorescent','fluid','fusion',
      'gaseous','galvanic','geometric','glycolytic',
      'hydrophilic','hydrophobic','hypertonic','hypotonic',
      'ionic','isomeric','isotopic','isotonic',
      'joule-rich','junctional',
      'kinetic',
      'lattice','luminescent','liquid',
      'malleable','metallic','molar','molecular','magnetic',
      'neutral','nucleophilic','nonpolar',
      'oxidative','osmotic','organic',
      'paramagnetic','photonic','polar','polymeric','precipitated',
      'quantized','quaternary',
      'radioactive','reactive','reductive','resonant',
      'saturated','stoichiometric','supersaturated','synthetic','soluble','solvent',
      'titrated','thermal','turbulent','tensile',
      'unsaturated','uniform','united','utopian',
      'valent','volatile','viscous',
      'weakly-bound','wavelike','wettable',
      'xenon-like','xeric',
      'yielding','ytterbic',
      'zeta-potential','zwitterionic'
    ];

    // ==== ELEMENTS & STATE ================================================
    const result = document.getElementById('result');

    const playBtn = document.getElementById('playBtn');
    const focusPlayBtn = document.getElementById('focusPlayBtn');
    const audioBtn = document.getElementById('audioBtn');
    const settingsBtn = document.getElementById('settingsBtn');

    const newPhraseBtn = document.getElementById('newPhraseBtn');
    const newAnimalBtn = document.getElementById('newAnimalBtn');
    const newNameBtn = document.getElementById('newNameBtn');
    const openSheetBtn = document.getElementById('openSheet');
    const enlargeBtn = document.getElementById('enlargeBtn');

    const alphaToggle = document.getElementById('alphaToggle');

    const sheet = document.getElementById('sheet');
    const pages = document.getElementById('pages');
    const tabs = document.querySelectorAll('.tab[data-ix]');
    const closeSheetBtn = document.getElementById('closeSheet');
    const flipPrev = document.getElementById('flipPrev');
    const flipNext = document.getElementById('flipNext');

    const grid12 = document.getElementById('grid12');
    const gridFJ = document.getElementById('gridFJ');
    const gridKO = document.getElementById('gridKO');
    const gridPZ = document.getElementById('gridPZ');

    const splash = document.getElementById('splash');

    // Settings controls
    const chkEmotion = document.getElementById('chkEmotion');
    const chkChem = document.getElementById('chkChem');
    const chkMove = document.getElementById('chkMove');
    const chkAnimal = document.getElementById('chkAnimal');
    const chkName = document.getElementById('chkName');
    const phoneticToggle = document.getElementById('phoneticToggle');
    const delayToggle = document.getElementById('delayToggle');

    let playing=true; let timer=null; let gapSec=5; // used when delay OFF
    let segSec=9; let wordDelay=3; // defaults per v19
    let audioOn=false; let phoneticOn=true;

    // Track current parts
    let current = { word: 'breathing', letter: 'b', animal: 'bear', name: 'Barry' };

    // Page 1 typing/suggestions state
    const p1Search = document.getElementById('page1Search');
    const p1Suggest = document.getElementById('p1Suggest');
    let p1List = []; let p1Index = -1; // -1 means none selected

    // ==== HELPERS ===========================================================
    const cap = s => s ? s[0].toUpperCase()+s.slice(1) : s;
    const rand = arr => arr[Math.floor(Math.random()*arr.length)];
    const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
    const nextLetter = l => letters[(letters.indexOf(l)+1+26)%26]||'a';
    const prevLetter = l => letters[(letters.indexOf(l)-1+26)%26]||'z';

    // Flatten lists for phonetic matching
    const animalsAll = Object.values(animalsByLetter).flat();
    const namesAll = Object.values(namesByLetter).flat();

    function initialPhoneme(w){
      const s=(w||'').toLowerCase();
      if(!s) return '';
      // clusters
      if(s.startsWith('ph')) return 'f';
      if(s.startsWith('sh')) return 'sh';
      if(s.startsWith('ch')) return 'ch';
      if(s.startsWith('th')) return 'th';
      if(s.startsWith('kn')||s.startsWith('gn')||s.startsWith('pn')) return 'n';
      if(s.startsWith('wr')) return 'r';
      if(s.startsWith('wh')) return 'w';
      if(s.startsWith('ps')) return 's';
      if(s.startsWith('qu')) return 'k'; // treat qu ≈ k
      // special vowels: "u" splits into "y" vs "ur"
      if(/^uni/.test(s) || /^ut/.test(s) || /^use/.test(s) || /^user/.test(s)) return 'y'; // e.g., uniform, utopia
      if(/^ur/.test(s)) return 'ur'; // urchin, ursula
      // single-letter rules
      const c=s[0]; const n=s[1]||'';
      if(c==='c') return 'eiy'.includes(n) ? 's' : 'k';
      if(c==='g') return 'eiy'.includes(n) ? 'j' : 'g';
      if(c==='x') return 'z';
      if(c==='q') return 'k';
      return c;
    }

    function getActiveFirstWordList(){
      let arr=[];
      if(chkEmotion.checked){ arr = arr.concat(emotionList, extraList); }
      if(chkMove.checked){ arr = arr.concat(movementList); }
      if(chkChem.checked){ arr = arr.concat(chemistryList); }
      if(!arr.length) arr = emotionList.slice();
      return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b));
    }

    function speak(text){
      try{
        if(!audioOn || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.7; // 70% speed
        window.speechSynthesis.speak(u);
      }catch(e){ /* ignore */ }
    }

    let t2=null, t3=null; // staged timers

    function render(word, opts={}){
      // stop any pending staged timeouts and speech
      [t2,t3].forEach(t=> clearTimeout(t));
      if('speechSynthesis' in window) window.speechSynthesis.cancel();

      const wRaw = (word||current.word);
      const w = wRaw.toLowerCase();
      const firstLetter = w[0]||current.letter||'a';
      const phon = initialPhoneme(w);

      // choose animal & name by phoneme or by letter
      if(!opts.keepAnimal){
        let pool = phoneticOn ? animalsAll.filter(a=> initialPhoneme(a)===phon) : (animalsByLetter[firstLetter]||[]);
        if(!pool.length) pool = animalsByLetter[firstLetter]||[]; // fallback
        let choice = rand(pool);
        if(choice===current.animal && pool.length>1){ choice = pool[(pool.indexOf(choice)+1)%pool.length]; }
        current.animal = choice;
      }
      if(!opts.keepName){
        let pool = phoneticOn ? namesAll.filter(n=> initialPhoneme(n)===phon) : (namesByLetter[firstLetter]||[]);
        if(!pool.length) pool = namesByLetter[firstLetter]||[];
        let choice = cap(rand(pool));
        if(choice===current.name && pool.length>1){ choice = cap(pool[(pool.indexOf(choice)+1)%pool.length]); }
        current.name = choice;
      }

      current.word = w; current.letter = firstLetter;

      const showAnimal = chkAnimal.checked;
      const showName = chkName.checked;

      // Delay mode: speak as each word appears
      result.innerHTML = `<span class="emo">${w}</span>`;
      speak(w);
      if(showAnimal){
        t2 = setTimeout(()=>{
          result.innerHTML = `<span class=\"emo\">${w}</span> <span class=\"animal\">${current.animal}</span>`;
          speak(current.animal);
        }, wordDelay*1000);
      }
      if(showName){
        const mul = showAnimal ? 2 : 1;
        t3 = setTimeout(()=>{
          result.innerHTML = `<span class=\"emo\">${w}</span>${showAnimal?` <span class=\"animal\">${current.animal}</span>`:''} <span class=\"name\">${current.name}</span>`;
          speak(current.name);
        }, mul*wordDelay*1000);
      }
    }

    function groupIdxForWord(w){ const f=w[0].toLowerCase(); if(f<'f') return 0; if(f<'k') return 1; if(f<'p') return 2; return 3; }
    function makeWordBtn(word){ const b=document.createElement('button'); b.className='btn small'; b.dataset.word=word; b.textContent=word[0].toUpperCase()+word.slice(1); return b; }

    function fillGrids(){
      const activeWords = getActiveFirstWordList();
      [grid12,gridFJ,gridKO,gridPZ].forEach(g=>g.innerHTML='');
      activeWords.forEach(w=>{ const ix=groupIdxForWord(w); const btn=makeWordBtn(w); ([grid12,gridFJ,gridKO,gridPZ][ix]).appendChild(btn); });
    }

    // Clicking grid buttons: choose that first word
    function onGridClick(e){ const b = e.target.closest('button.btn'); if(!b) return; const w=b.dataset.word; if(!w) return; render(w, { keepAnimal:false, keepName:false }); }
    grid12.addEventListener('click', onGridClick);
    gridFJ.addEventListener('click', onGridClick);
    gridKO.addEventListener('click', onGridClick);
    gridPZ.addEventListener('click', onGridClick);

    // ==== PAGE 1: Typing + suggestions with keyboard control ==============
    function p1RenderSuggest(list, query){
      p1Suggest.innerHTML='';
      if(!list.length) { p1Index=-1; return; }
      const ul=document.createElement('ul');
      list.slice(0,50).forEach((w,i)=>{ const li=document.createElement('li');
        const first=query.length; const label=w[0].toUpperCase()+w.slice(1);
        li.innerHTML = `<strong>${label.slice(0,first)}</strong>${label.slice(first)}`;
        li.setAttribute('role','option'); li.setAttribute('aria-selected', String(i===p1Index));
        li.addEventListener('mouseenter',()=>{ p1Index=i; updateP1Highlight(); });
        li.addEventListener('click',()=>{ p1Index=i; chooseP1Index(); });
        ul.appendChild(li); });
      p1Suggest.appendChild(ul);
    }
    function updateP1Highlight(){ const items=p1Suggest.querySelectorAll('li'); items.forEach((li,i)=> li.setAttribute('aria-selected', String(i===p1Index))); }
    function chooseP1Index(){ if(p1Index<0 || p1Index>=p1List.length) return; const word=p1List[p1Index]; p1Suggest.innerHTML=''; p1Search.value=''; render(word,{keepAnimal:false,keepName:false}); }

    p1Search.addEventListener('input', e=>{
      const q=e.target.value.trim().toLowerCase();
      if(!q){ p1Suggest.innerHTML=''; return; }
      const newLetter=q[0];
      // pick animals/names live (keep or refresh by letter)
      if(newLetter!==current.letter){ render(q,{keepAnimal:false,keepName:false}); } else { render(q,{keepAnimal:true,keepName:true}); }
      const activeWords = getActiveFirstWordList();
      p1List = activeWords.filter(w=>w.startsWith(q));
      p1Index = p1List.length?0:-1;
      p1RenderSuggest(p1List,q);
    });

    p1Search.addEventListener('keydown', e=>{
      const key=e.key;
      if(key==='ArrowDown'){ e.preventDefault(); if(!p1List.length) return; p1Index=(p1Index+1)%p1List.length; updateP1Highlight(); return; }
      if(key==='ArrowUp'){ e.preventDefault(); if(!p1List.length) return; p1Index=(p1Index-1+p1List.length)%p1List.length; updateP1Highlight(); return; }
      if(key==='Enter'){
        e.preventDefault();
        if(p1List.length && p1Index>=0){ chooseP1Index(); }
        else { newPhraseAlpha(+1); }
        return;
      }
      if(key==='ArrowRight'){ e.preventDefault(); newPhraseAlpha(+1); return; }
      if(key==='ArrowLeft'){ e.preventDefault(); newPhraseAlpha(-1); return; }
    });

    // ==== Buttons & phrase generation =====================================
    function pickWordForLetter(l){ const activeWords=getActiveFirstWordList(); const list=activeWords.filter(w=>w.startsWith(l)); return list.length?rand(list):null; }
    function newPhraseAlpha(step=1){
      let l=current.letter||'a';
      if(alphaToggle.checked){ l = step>0? nextLetter(l) : prevLetter(l); }
      let w = pickWordForLetter(l);
      if(!w){ for(let i=0;i<26;i++){ l = step>0? nextLetter(l) : prevLetter(l); w = pickWordForLetter(l); if(w) break; } }
      render(w||rand(getActiveFirstWordList()), { keepAnimal:false, keepName:false });
    }

    function newPhrase(){ if(alphaToggle.checked) newPhraseAlpha(+1); else render(rand(getActiveFirstWordList()), { keepAnimal:false, keepName:false }); }
    function newAnimal(){ if(!chkAnimal.checked) return; render(current.word,{ keepName:true }); }
    function newName(){ if(!chkName.checked) return; render(current.word,{ keepAnimal:true }); }

    newPhraseBtn.addEventListener('click', newPhrase);
    newAnimalBtn.addEventListener('click', newAnimal);
    newNameBtn.addEventListener('click', newName);

    // Enlarge/Minimize
    enlargeBtn.addEventListener('click', ()=> document.body.classList.add('focus'));
    document.getElementById('minimizeBtn').addEventListener('click', ()=> document.body.classList.remove('focus'));

    // Clicking prompt or empty space => new phrase
    result.addEventListener('click', ()=> newPhrase());
    document.body.addEventListener('click', (e)=>{
      if(e.target.closest('button, input, .sheet, .suggestions, .toggle, .output, .focusControls')) return;
      newPhrase();
    });

    // ==== Bottom sheet controls ===========================================
    let curPage = 0; // 0..3
    function applyPage(){ pages.style.transform = `translateX(-${curPage*100}vw)`; tabs.forEach(t=>t.classList.remove('active')); const active = Array.from(tabs).find(t=>Number(t.dataset.ix)===curPage); if(active) active.classList.add('active'); }
    function openSheet(){ sheet.classList.add('open'); }
    function closeSheet(){ sheet.classList.remove('open'); }
    openSheetBtn.addEventListener('click', openSheet);
    closeSheetBtn.addEventListener('click', closeSheet);
    tabs.forEach(t=> t.addEventListener('click', ()=>{ curPage = Number(t.dataset.ix)||0; applyPage(); }));
    flipPrev.addEventListener('click', ()=>{ curPage = (curPage+3)%4; applyPage(); });
    flipNext.addEventListener('click', ()=>{ curPage = (curPage+1)%4; applyPage(); });
    document.addEventListener('keydown', e=>{ if(!sheet.classList.contains('open')) return; if(e.key==='ArrowRight'){ e.preventDefault(); flipNext.click(); } if(e.key==='ArrowLeft'){ e.preventDefault(); flipPrev.click(); } });

    // ==== Gestures ==========================================================
    let startX=null, startY=null, handled=false; const H=35, V=60;
    window.addEventListener('pointerdown', e=>{ startX=e.clientX; startY=e.clientY; handled=false; }, {passive:false});
    window.addEventListener('pointermove', e=>{
      if(startX===null) return;
      const dx=e.clientX-startX, dy=e.clientY-startY; const ax=Math.abs(dx), ay=Math.abs(dy);
      if(handled) { e.preventDefault(); return; }
      if(ax>H && ax>ay){ // horizontal
        if(sheet.classList.contains('open')){ if(dx>0){ curPage=(curPage+3)%4; } else { curPage=(curPage+1)%4; } applyPage(); }
        else { if(dx>0){ document.body.classList.add('focus'); } else { document.body.classList.remove('focus'); } }
        handled=true; e.preventDefault(); return;
      }
      if(ay>V && ay>ax){ // vertical
        if(dy<0){ openSheet(); } else { if(sheet.classList.contains('open')) closeSheet(); }
        handled=true; e.preventDefault(); return;
      }
    }, {passive:false});
    window.addEventListener('pointerup', ()=>{ startX=null; startY=null; handled=false; }, {passive:false});

    // ==== Auto-play & Settings ============================================
    function updatePlayButtons(){ playBtn.classList.toggle('active',playing); focusPlayBtn.classList.toggle('active',playing); focusPlayBtn.textContent = playing ? 'Stop' : 'Play'; }
    function scheduleNext(){ if(!playing) return; clearTimeout(timer); timer=setTimeout(()=>{ newPhrase(); scheduleNext(); }, segSec*1000); }
    function togglePlay(){ playing=!playing; updatePlayButtons(); if(playing) scheduleNext(); else clearTimeout(timer); }
    playBtn.addEventListener('click', togglePlay); focusPlayBtn.addEventListener('click', togglePlay);

    const settingsSheet = document.getElementById('settings');
    function toggleSettings(){ const open = settingsSheet.classList.toggle('open'); settingsBtn.classList.toggle('active', open); }
    settingsBtn.addEventListener('click', toggleSettings);
    settingsSheet.addEventListener('click', e=>{ if(e.target.id==='settings'){ settingsSheet.classList.remove('open'); settingsBtn.classList.remove('active'); }});

    // Delay controls
    document.querySelectorAll('.setWordGap').forEach(b=> b.addEventListener('click', ()=>{ wordDelay = Number(b.dataset.v)||3; render(current.word,{ keepAnimal:true, keepName:true }); }));
    document.querySelectorAll('.setSeg').forEach(b=> b.addEventListener('click', ()=>{ segSec = Number(b.dataset.v)||9; if(playing) scheduleNext(); }));

    // Group toggles & phonetic toggle
    [chkEmotion, chkChem, chkMove].forEach(el=> el.addEventListener('change', ()=>{ fillGrids(); p1Suggest.innerHTML=''; }));
    [chkAnimal, chkName].forEach(el=> el.addEventListener('change', ()=>{ render(current.word,{ keepAnimal:true, keepName:true }); }));
    phoneticToggle.addEventListener('change', ()=>{ phoneticOn=phoneticToggle.checked; render(current.word,{ keepAnimal:false, keepName:false }); });

    // Audio toggle
    function updateAudioBtn(){ audioBtn.classList.toggle('active', audioOn); }
    audioBtn.addEventListener('click', ()=>{ audioOn=!audioOn; updateAudioBtn(); if(!audioOn && 'speechSynthesis' in window) window.speechSynthesis.cancel(); });

    // Global PC shortcuts
    document.addEventListener('keydown', e=>{ if(document.activeElement===p1Search) return; if(e.key==='Enter'){ e.preventDefault(); newPhraseAlpha(+1); } if(e.key==='ArrowRight'){ e.preventDefault(); newPhraseAlpha(+1); } if(e.key==='ArrowLeft'){ e.preventDefault(); newPhraseAlpha(-1); } });

    // Try fullscreen after first interaction
    let triedFS=false; function tryFS(){ if(triedFS) return; triedFS=true; const el=document.documentElement; const fn=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen; if(fn) { try{ fn.call(el); }catch(e){} } }
    window.addEventListener('pointerdown', tryFS, { once:true });

    // Splash hide after 30s
    setTimeout(()=>{ splash.classList.add('hide'); }, 30000);

    // Boot ------------------------------------------------------------------
    updatePlayButtons();
    fillGrids();
    render('breathing', { keepAnimal:true, keepName:true });
    scheduleNext(); // start in play mode
  </script>
</body>
</html>

